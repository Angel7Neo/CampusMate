<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CampusMate Login</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f0f4f8; margin:0; padding:0; }
    .container { max-width: 400px; margin: 50px auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);}
    h2 { text-align: center; margin-bottom: 20px; }
    label { display: block; margin-bottom: 5px; font-weight: bold; }
    input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 5px; }
    button { width: 100%; padding: 12px; background: #3b77cc; color: white; border: none; border-radius: 5px; cursor: pointer; }
    button:hover { background: #2851a3; }
    .otp-container { display: none; text-align: center; }
    .otp-inputs { display: flex; justify-content: center; gap: 10px; margin: 20px 0; }
    .otp-inputs input { width: 40px; height: 40px; text-align: center; font-size: 18px; border: 1px solid #ccc; border-radius: 5px; }
    .resend-otp { color: #3b77cc; cursor: pointer; margin-top: 10px; }
    .error { color: red; text-align: center; margin-bottom: 10px; }
    .success { color: green; text-align: center; margin-bottom: 10px; }
  </style>
</head>
<body>

<div class="container" id="loginFormContainer">
  <h2>Student Login</h2>
  <p class="error" id="errorMsg"></p>
  <p class="success" id="successMsg"></p>
  <label for="email">CPUT Email</label>
  <input type="email" id="email" placeholder="student@mycput.ac.za" />
  
  <label for="password">Password</label>
  <input type="password" id="password" placeholder="Enter password" />
  
  <button id="loginButton">Login</button>
</div>

<div class="container otp-container" id="otpContainer">
  <h2>OTP Verification</h2>
  <p>Enter the 6-digit OTP sent to your phone/email</p>
  <div class="otp-inputs">
    <input type="text" maxlength="1" class="otp-digit">
    <input type="text" maxlength="1" class="otp-digit">
    <input type="text" maxlength="1" class="otp-digit">
    <input type="text" maxlength="1" class="otp-digit">
    <input type="text" maxlength="1" class="otp-digit">
    <input type="text" maxlength="1" class="otp-digit">
  </div>
  <button id="verifyOtpBtn">Verify OTP</button>
  <div class="resend-otp" id="resendOtp">Resend OTP</div>
</div>

<script>
let currentPhoneNumber = "";

const loginButton = document.getElementById("loginButton");
const verifyOtpBtn = document.getElementById("verifyOtpBtn");
const otpInputs = document.querySelectorAll(".otp-digit");
const errorMsg = document.getElementById("errorMsg");
const successMsg = document.getElementById("successMsg");

loginButton.addEventListener("click", async () => {
  errorMsg.textContent = "";
  successMsg.textContent = "";

  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value;

  if (!email || !password) {
    errorMsg.textContent = "All fields are required";
    return;
  }

  if (!email.endsWith("@mycput.ac.za")) {
    errorMsg.textContent = "Use your @mycput.ac.za email only";
    return;
  }

  try {
    const response = await fetch("http://localhost:3001/api/auth/login", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email, password })
    });

    const data = await response.json();

    if (!response.ok) {
      errorMsg.textContent = data.message || "Login failed";
      return;
    }

    successMsg.textContent = "Login successful! OTP sent.";
    currentPhoneNumber = data.phone_number; // backend should return phone number

    document.getElementById("loginFormContainer").style.display = "none";
    document.getElementById("otpContainer").style.display = "block";

  } catch (err) {
    console.error(err);
    errorMsg.textContent = "Server error, try again later.";
  }
});

// OTP input auto-focus
otpInputs.forEach((input, index) => {
  input.addEventListener("input", () => {
    if (input.value.length === 1 && index < otpInputs.length - 1) {
      otpInputs[index + 1].focus();
    }
  });
  input.addEventListener("keydown", (e) => {
    if (e.key === "Backspace" && input.value === "" && index > 0) {
      otpInputs[index - 1].focus();
    }
  });
});

verifyOtpBtn.addEventListener("click", async () => {
  const otp = Array.from(otpInputs).map(i => i.value).join("");
  errorMsg.textContent = "";
  successMsg.textContent = "";

  if (otp.length !== 6) {
    errorMsg.textContent = "Enter a 6-digit OTP";
    return;
  }

  try {
    const response = await fetch("http://localhost:3001/api/auth/verify-otp", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ phone_number: currentPhoneNumber, otp })
    });

    const data = await response.json();

    if (!response.ok) {
      errorMsg.textContent = data.message || "OTP verification failed";
      return;
    }

    successMsg.textContent = "OTP verified! Redirecting...";
    setTimeout(() => { window.location.href = "bookingPage.html"; }, 1500);

  } catch (err) {
    console.error(err);
    errorMsg.textContent = "Server error, try again later.";
  }
});

// Resend OTP
document.getElementById("resendOtp").addEventListener("click", async () => {
  otpInputs.forEach(i => i.value = "");
  otpInputs[0].focus();
  alert("OTP resent (simulate backend call)");
});
</script>

</body>
</html>
